---
title: "Homework 3 - BUSN 41204"
author: "Fernando Garcia, Paula Gaviria, Victor Fuentes"
date: "02/06/2021"
geometry: margin = 0.75in
output:
  pdf_document:
    number_sections: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = TRUE,
  message = FALSE,
  warning = FALSE,
  fig.width = 7,
  fig.height = 5,
  fig.align = "center"
)
options(scipen = 10^6)
```

**Setup**
```{r}
library(data.table)
library(ggplot2)
library(ggpubr)
library(viridis)
library(randomForest)
library(pdp)
library(iml)
library(gbm)
```

# Loading Data
```{r}
setwd("C:/Users/vfuentesc/OneDrive - The University of Chicago/Winter 2021/Machine Learning/Week 3/HW3-ML")
train = data.table(read.csv("Bike_train.csv"))
test = data.table(read.csv("Bike_test.csv"))
```

```{r}
train[, log_count := log(count + 1)]
train[, count := NULL]

season_labels = c("Winter", "Spring", "Summer", "Fall")
train[, season := factor(season, levels = 1:4, labels = season_labels)]
train[, weather := factor(weather)]
```

\newpage

# Questions 

## Data Exploration

a. Visualize the relationship between count and each one of the following variables on a separate scatter plot: `windspeed`, `humidity`, `temp`, and `atemp`.

```{r indent = "    "}
scatter_plot = function(x_var){
return(ggplot(train, aes(x = get(x_var), y = log_count,color = season, fill = season)) +
         geom_point(shape = 21, size = 1.5, stroke = 0.1, alpha = 0.2) +
         scale_fill_viridis_d(option = "A", end = 0.8, direction = -1) + scale_color_viridis_d(option = "A", end = 0.8, direction = -1) +
         labs(x = x_var, fill = "Season", color = "Season") + theme_bw())}
```

```{r fig.height = 6, fig.width = 6, indent = "    "}
annotate_figure(ggarrange(scatter_plot("windspeed"), scatter_plot("humidity"),
                          scatter_plot("temp"), scatter_plot("atemp"),
                          common.legend = TRUE),
                top = text_grob("windspeed/humidity/temp/atemp vs. count", face = "bold"))
```

    *Outliers in `humidity` (atypical zero values) and `atemp` (very low values atemp for a Summer season).*

\newpage
b. How does count depend on the season? Consider visualizing this relationship with a boxplot.

```{r indent = "    "}
season_boxplot =
  ggplot(train, aes(x = season, y = log_count)) + 
    geom_boxplot(aes(color = season), size = 0.75) +
    geom_jitter(aes(color = season), size = 0.75, alpha = 0.1) +
    scale_color_viridis_d(option = "A", end = 0.8, direction = -1) +
    labs(x = "Season") + theme_bw() + theme(legend.position = "none")

weather_boxplot = ggplot(train, aes(x = weather, y = log_count)) + 
    geom_boxplot(aes(color = weather), size = 0.75) +
    geom_jitter(aes(color = weather), size = 0.75, alpha = 0.1) +
    scale_color_viridis_d(option = "D", end = 0.8, direction = -1) +
    labs(x = "Weather") + theme_bw() + theme(legend.position = "none")
```

```{r fig.height = 5, fig.width = 10, indent = "    "}
annotate_figure(ggarrange(season_boxplot, weather_boxplot),
                top = text_grob("season/weather vs. count", face = "bold"))
```

    *There is less rentals (`count`) during Winter `season`. On the other hand, `weather` shows irregular values with decimals points.*

c. How does `count` depend on the time of the day (`hour`)? Does this relationship change depending on whether it is a `workingday` or not? You might consider coloring the observations by the temperature (`temp` or `atemp`).

```{r indent = "    "}
hour_wkday_lines =
  ggplot(train, aes(x = factor(hour), y = log_count, group = factor(workingday), color = factor(workingday))) +
    stat_summary(fun.y = mean, geom = "line", na.rm = TRUE, group = NA, color = "black") +
    stat_summary(fun.y = mean, geom = "point", na.rm = TRUE, group = NA, color = "black") + 
    stat_summary(fun.data = mean_cl_boot, geom = "errorbar", width = 0.25, na.rm = TRUE, group = NA, color = "black") +
    stat_summary(fun.y = mean, geom = "line") +
    stat_summary(fun.y = mean, geom = "point") +
    stat_summary(fun.data = mean_cl_boot, geom = "errorbar", width = 0.25) +
    scale_color_manual(values = c("hotpink", "lightblue"), labels = c("No Working Day", "Working Day")) + 
    labs(x = "Hour", color = "", title = "hour vs. count & workingday") + theme_bw() +
    theme(plot.title = element_text(hjust = 0.5, face = "bold"), legend.position = c(0.9, 0.15), legend.background = element_rect(fill=NA))
    
hour_wkday_temp_boxplot =
  ggplot(train, aes(x = factor(hour), y = log_count)) + 
    geom_boxplot(size = 0.6, color = "gray21", outlier.color = NA) +
    geom_jitter(aes(color = temp), size = 1, alpha = 0.25) +
    scale_color_viridis_c(option = "A", end = 0.8, direction = -1) +
    labs(x = "Hour", color = "Temperature", title = "hour vs. count & temp by workingday") + theme_bw() +
    facet_grid(~workingday, labeller = labeller(workingday = c("0" = "No Working Day", "1" = "Working Day"))) +
    theme(plot.title = element_text(hjust = 0.5, face = "bold"), legend.position = c(0.85, 0.10), legend.background = element_rect(fill=NA), legend.direction = "horizontal", legend.key.height = unit(0.25,"cm"))
```


```{r fig.height = 7, fig.width = 8, indent = "    "}
ggarrange(hour_wkday_lines, hour_wkday_temp_boxplot, nrow = 2)
```

    *Bike demand higher during peak hours (7-9am and 4-7pm). However, this only remains for working days. During no working days, bike demand is higher from 10am to 6pm. Additionally, irrespective of whether is working day or not, the higher the temperature, the higher the demand for bikes.*

\newpage
d. Does the relationship between `count` and `hour` change by season?

```{r indent = "    "}
hour_season_lines =
  ggplot(train, aes(x = factor(hour), y = log_count, group = season, color = season)) +
    stat_summary(fun.y = mean, geom = "line") +
    stat_summary(fun.y = mean, geom = "point") +
    stat_summary(fun.data = mean_cl_boot, geom = "errorbar", width = 0.25) +
    scale_color_viridis_d(option = "A", end = 0.8, direction = -1) +
    labs(x = "Hour", color = "", title = "hour vs. count & season") + theme_bw() +
    theme(plot.title = element_text(hjust = 0.5, face = "bold"), legend.position = c(0.9, 0.2), legend.background = element_rect(fill=NA), legend.key.height = unit(0.5,"cm"))

hour_season_wkdy_lines =
  ggplot(train, aes(x = factor(hour), y = log_count, group = season, color = season)) +
    stat_summary(fun.y = mean, geom = "line") +
    stat_summary(fun.y = mean, geom = "point") +
    stat_summary(fun.data = mean_cl_boot, geom = "errorbar", width = 0.25) +
    scale_color_viridis_d(option = "A", end = 0.8, direction = -1) +
    labs(x = "Hour", color = "", title = "hour vs. count & season by workingday") + theme_bw() +
    facet_grid(~workingday, labeller = labeller(workingday = c("0" = "No Working Day", "1" = "Working Day"))) +
    theme(plot.title = element_text(hjust = 0.5, face = "bold"), legend.position = "none", legend.background = element_rect(fill=NA))
```

```{r fig.height = 7, fig.width = 10, indent = "    "}
ggarrange(hour_season_lines, hour_season_wkdy_lines, nrow = 2)
```

    *Consistently, there is less demand during Winter. Moreover, demand in Spring/Summer/Fall is almost statistically the same along the day irrespective of whether is a working day or not*

\newpage
e. Does the distribution of hourly number of rentals change between 2011 and 2012? What does this tell you about the rental business?

```{r indent = "    "}
hour_year_lines =
  ggplot(train, aes(x = factor(hour), y = log_count, group = factor(year), color = factor(year))) +
    stat_summary(fun.y = mean, geom = "line") +
    stat_summary(fun.y = mean, geom = "point") +
    stat_summary(fun.data = mean_cl_boot, geom = "errorbar", width = 0.25) +
    scale_color_viridis_d(option = "D", end = 0.8, direction = -1) +
    labs(x = "Hour", color = "Year", title = "hour vs. count & year") + theme_bw() +
    theme(plot.title = element_text(hjust = 0.5, face = "bold"), legend.position = c(0.9, 0.15), legend.background = element_rect(fill=NA))

hour_year_month_lines =
  ggplot(train, aes(x = factor(month), y = log_count, group = factor(year), color = factor(year))) +
    stat_summary(fun.y = mean, geom = "line") +
    stat_summary(fun.y = mean, geom = "point") +
    stat_summary(fun.data = mean_cl_boot, geom = "errorbar", width = 0.25) +
    scale_color_viridis_d(option = "D", end = 0.8, direction = -1) +
    labs(x = "Month", color = "Year", title = "month vs. count & year") + theme_bw() +
    theme(plot.title = element_text(hjust = 0.5, face = "bold"), legend.position = c(0.9, 0.15), legend.background = element_rect(fill=NA))
```

```{r fig.height = 7, fig.width = 10, indent = "    "}
ggarrange(hour_year_lines, hour_year_month_lines, nrow = 2)
```

    *Yes, it changes. Rental business has expanded between 2011 and 2012. *

\newpage

## Fitting a Random Forest model and a Boosting model

a.  Create a partial dependence plot for predicted `count` vs each one of the following variables: `windspeed`, `humidity`, `temp`, and `atemp.` Do this for both the *Random Forest* and the *Boosting* model.

```{r indent = "    "}
pdp_plot = function(model, pred_var, ylim, n.trees = NULL){
  if (as.character(substitute(model)) == "fit_rf") {
  temp = autoplot(partial(model, pred_var), rug = T, train = train) 
  } else if (as.character(substitute(model)) == "fit_gbm") {
  temp = autoplot(partial(model, pred_var, n.trees = n.trees), rug = T, train = train)
  } else{
  return(print("No recognized model"))
  }
  return(temp + scale_y_continuous(limits = ylim) + theme_bw())
}
```

    **Random Forest model**

```{r indent = "    ", cache = TRUE}
fit_rf = randomForest(log_count ~ ., data = train, mtry = 4,
                       ntree = 1000, nodesize = 25, keep.inbag = TRUE, importance = TRUE)
```

```{r fig.height = 7, fig.width = 10, indent = "    ", cache = TRUE}
ylim = c(4.0, 4.8)
annotate_figure(ggarrange(pdp_plot(fit_rf, "windspeed", ylim), pdp_plot(fit_rf, "humidity", ylim),
                          pdp_plot(fit_rf, "temp", ylim), pdp_plot(fit_rf, "atemp", ylim)),
                top = text_grob("PDP using RF: windspeed/humidity/temp/atemp vs. count", face = "bold"))
```

    *Using a simple Random Forest model with `ntree` of 1,000 and `mtry` of 4, we find that `windspeed` almost doesn't predict `yhat`, while `humidity` shows a negative relationship. Moreover, both `temp` and `atemp` present a positive relationship with `yhat` below ~30 Celsius degress.*

    **Boosting model**

```{r indent = "    ", cache = TRUE}
fit_gbm = gbm(log_count ~ ., data = train, distribution = "gaussian", 
              interaction.depth = 1, n.trees = 5000, shrinkage = 0.01,
              cv.folds = 5, n.cores = 1, verbose = FALSE)
```

```{r fig.height = 7, fig.width = 10, indent = "    ", cache = TRUE}
n_trees = 5000
annotate_figure(ggarrange(pdp_plot(fit_gbm, "windspeed", ylim, n_trees), pdp_plot(fit_gbm, "humidity", ylim, n_trees),
                          pdp_plot(fit_gbm, "temp", ylim, n_trees), pdp_plot(fit_gbm, "atemp", ylim, n_trees)),
                top = text_grob("PDP using GBM: windspeed/humidity/temp/atemp vs. count", face = "bold"))
```

    *GBM: Explanation*

\newpage

b. Build a marginal model that regresses count on each one of the following variables: `windspeed`, `humidity`, `temp`, and `atemp.` You can use whichever nonlinear model you want for these regression tasks. Plot the marginal fits and compare them with partial dependence plots above. How are the plots different and why?

```{r indent = "    "}
poly_plot = function(x_var){
return(ggplot(train, aes(x = get(x_var), y = log_count)) +
         geom_smooth(formula = y ~ poly(x, 10), se = FALSE, color = "black", size = 0.5) +
         scale_y_continuous(limits = c(1, 5)) +
         labs(x = x_var) + theme_bw())
}
```

```{r fig.height = 7, fig.width = 10, indent = "    "}
annotate_figure(ggarrange(poly_plot("windspeed"), poly_plot("humidity"),
                          poly_plot("temp"), poly_plot("atemp")),
                top = text_grob("PDP using Polynomial (10): windspeed/humidity/temp/atemp vs. count", face = "bold"))
```

    *Analysis. A model with a single regressor is so poor*

\newpage

c. Create variable importance plots for the two models in part 2.a. Do the two models rank the variables in the same way?

```{r indent = "    ", include = FALSE}
importance_rf = as.data.table(fit_rf$importance, keep.rownames = T)
importance_gbm = as.data.table(summary(fit_gbm))
```

```{r indent = "    ", eval = FALSE}
importance_rf = as.data.table(fit_rf$importance, keep.rownames = T)
importance_gbm = as.data.table(summary(fit_gbm))
```

```{r fig.height = 5, fig.width = 10, indent = "    "}
importance_features = list(coord_flip(), theme_bw(),
                           theme(plot.title = element_text(hjust = 0.5, face = "bold")))

annotate_figure(ggarrange(ggplot(importance_rf, aes(x = reorder(rn, `%IncMSE`), y = `%IncMSE`)) +
                            geom_col(fill = "hotpink") + labs(x = "", title = "RF") +
                            importance_features,
                          ggplot(importance_gbm, aes(x = reorder(var, rel.inf), y = rel.inf)) +
                            geom_col(fill = "navyblue") + labs(x = "", title = "GBM") +
                            importance_features),
                top = text_grob("Importance: RF vs GBM", face = "bold"))
```

    *RF and GBM rank the same the first 2 variables: `hour` and `daylabel`. RF ranks `atemp` better than `temp`, while GBM ranks the opposite. Additionally, both models rank `holiday` as the worst predictor variable. *

\newpage

## Investigate how predictive each variable is on its own.

There are a number of ways to do this. The simplest way would be to regress `count` on each one of the variables separately and evaluate the out-of-sample MSE for each one of the models. For instance, you could fit a regression tree model.

a.  What can you say by comparing how predictive each variable is on its own vs the variable importance ranking obtained in the previous question? 

b. Why do you think is the reason for the difference?

c. How could you use the variable importance ranking to select variables? We will talk about this in detail in Week 5. Here I want you to think a bit about the variable selection problem and how would you use the tools that you have learnt so far to identify a good set of variables.

\newpage
## Build a model to predict the bikeshare counts

Save your predictions to a `.csv` file that you will submit to Kaggle (see Kaggle instruction below.) Provide a write-up that explains how you went about building your model. Attach the code to create the submission `.csv` file as an appendix to your homework submission. 

\newpage
# Appendix

```{r eval = FALSE}
sampleSubmission = data.table(Id = 1:length(yhat),
                              count=yhat)

write.csv(sampleSubmission,
          file = "sampleSubmission.csv",
          row.names = FALSE,
          quote = FALSE)
```




